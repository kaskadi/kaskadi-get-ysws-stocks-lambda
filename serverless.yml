service:
  name: kaskadi-stock-update-lambda

package:
  individually: true
  exclude:
    - "**/**"

provider:
  name: aws
  runtime: nodejs10.x
  stackName: ${self:service.name}-stack
  stage: ${opt:stage, 'prod'}
  region: ${opt:region, 'eu-central-1'}
  deploymentBucket:
    name: ${env:SLS_DEPLOY_BUCKET}
  deploymentPrefix: '@kaskadi/${self:service.name}'
  apiGateway:
    restApiId: !ImportValue KaskadiStocksRestAPIGatewayId
    restApiRootResourceId: !ImportValue KaskadiStocksRestAPIGatewayRootResourceId
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sns:Publish
      Resource: !Ref KaskadiStockUpdater

functions:
  KaskadiStockUpdate:
    handler: kaskadi-stock-update-lambda.handler
    name: ${self:service.name}
    package:
      include:
        - 'kaskadi-stock-update-lambda.js'
        - 'node_modules/**'
    events:
      - http:
          method: get
          path: update
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId: !ImportValue KaskadiStocksCognitoAuthorizerId

resources:
  Resources:
    KaskadiStockUpdater:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: KaskadiStockUpdater
        DisplayName: Klimapartner's stock updater
  Outputs:
    KaskadiStockUpdaterArn:
      Value:
        Ref: KaskadiStockUpdater
      Export:
        Name: KaskadiStockUpdaterArn
